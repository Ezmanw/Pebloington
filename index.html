<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3 File Explorer</title>
    <!-- Google Fonts (Comfortaa) and Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script type="module" src="https://esm.run/@material/web/all.js"></script>
    
    <style>
        /* Base styles for the explorer UI */
        body {
            font-family: 'Comfortaa', sans-serif;
            background-color: #F7F2FA;
            color: #1C1B1F;
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
        }
        .main-container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }

        /* --- CRITICAL FIX FOR FLASH --- */
        /* If body has .viewer-mode, IMMEDIATELY hide the explorer content */
        body.viewer-mode .main-container {
            display: none !important;
        }
        
        /* Styles ONLY for the clean media viewer page */
        body.viewer-mode {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #111;
            overflow: hidden;
        }
        .fullscreen-media {
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Other explorer styles */
        .hidden { display: none !important; }
        .card { background-color: #F3EDF7; border-radius: 28px; padding: 24px; border: 1px solid #CAC4D0; }
        #repoTitle { font-size: 1.75rem; line-height: 2.25rem; font-weight: 700; color: #6750A4; word-break: break-all; }
        #breadcrumbs { display: flex; align-items: center; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
        .breadcrumb-link { color: #6750A4; cursor: pointer; font-weight: 500; border-radius: 8px; padding: 4px 8px; }
        .breadcrumb-link:hover { background-color: #EADDFF; }
        .breadcrumb-separator { color: #49454F; }
        md-list-item { --md-list-item-label-text-color: #000000; --md-list-item-label-text-font: 'Comfortaa', sans-serif; }
        md-list-item::part(start) { color: #6750A4; }
        #messageCenter { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: #49454F; }
        #messageCenter p { margin-top: 16px; font-weight: 500; }
        #displayView { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
        #editView { display: flex; flex-direction: column; gap: 16px; }
        .input-row { display: flex; flex-direction: column; }
        @media (min-width: 640px) { .input-row { flex-direction: row; gap: 16px; } }
        .input-row md-filled-text-field { flex-grow: 1; }
    </style>
</head>
<body>

    <!-- This tiny script runs BEFORE anything is rendered to prevent the UI flash -->
    <script>
        try {
            const params = new URLSearchParams(window.location.search);
            if (params.has('view')) {
                document.body.classList.add('viewer-mode');
            }
        } catch (e) {
            // Failsafe for older browsers
        }
    </script>

    <div class="main-container">
        <div class="container">
            <header class="card">
                <div id="displayView">
                    <div>
                        <span style="color: #49454F;">Current Repository</span>
                        <h2 id="repoTitle">Detecting...</h2>
                    </div>
                    <md-filled-tonal-button id="changeRepoBtn">Change</md-filled-tonal-button>
                </div>
                <div id="editView" class="hidden">
                    <div class="input-row">
                        <md-filled-text-field id="userInput" label="GitHub User or Org"></md-filled-text-field>
                        <md-filled-text-field id="repoInput" label="Repository Name"></md-filled-text-field>
                    </div>
                    <md-filled-button id="saveRepoBtn">Save & Load</md-filled-button>
                </div>
            </header>
            <main class="card">
                 <div id="breadcrumbs"></div>
                 <div id="fileListContainer">
                    <div id="messageCenter"></div>
                    <md-list id="fileList"></md-list>
                 </div>
            </main>
        </div>
    </div>

    <script type="module">
        // This function decides what the page should do.
        const initializePage = () => {
            // Check if the body has the viewer-mode class we added in the inline script.
            if (document.body.classList.contains('viewer-mode')) {
                const urlParams = new URLSearchParams(window.location.search);
                const mediaUrl = urlParams.get('view');
                const mediaType = urlParams.get('type');

                if (mediaUrl) {
                    let mediaElement;
                    if (mediaType === 'image') {
                        mediaElement = document.createElement('img');
                    } else {
                        mediaElement = document.createElement('video');
                        mediaElement.controls = true;
                        mediaElement.autoplay = true;
                    }
                    mediaElement.src = decodeURIComponent(mediaUrl);
                    mediaElement.className = 'fullscreen-media';
                    document.body.appendChild(mediaElement);
                }
                // Stop here, don't initialize the explorer.
                return; 
            }
            
            // If not in viewer mode, run the normal File Explorer Logic.
            initializeExplorer();
        };

        const initializeExplorer = () => {
            const displayView = document.getElementById('displayView');
            const editView = document.getElementById('editView');
            const changeRepoBtn = document.getElementById('changeRepoBtn');
            const saveRepoBtn = document.getElementById('saveRepoBtn');
            const repoTitle = document.getElementById('repoTitle');
            const userInput = document.getElementById('userInput');
            const repoInput = document.getElementById('repoInput');
            const breadcrumbs = document.getElementById('breadcrumbs');
            const fileList = document.getElementById('fileList');
            const messageCenter = document.getElementById('messageCenter');

            const VIEWABLE_EXTENSIONS = {
                image: ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'],
                video: ['mp4', 'webm', 'ogg']
            };

            const detectRepoInfo = () => {
                const hostname = window.location.hostname;
                const pathname = window.location.pathname;
                if (hostname.endsWith('github.io')) {
                    const user = hostname.split('.')[0];
                    const repo = pathname.split('/')[1] || '';
                    return { user, repo };
                }
                return { user: null, repo: null };
            };

            const loadRepo = async (user, repo, path = '') => {
                fileList.innerHTML = '';
                messageCenter.innerHTML = `<md-circular-progress indeterminate></md-circular-progress><p>Loading Files...</p>`;
                messageCenter.classList.remove('hidden');
                breadcrumbs.innerHTML = '';

                try {
                    const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`);
                    if (!response.ok) throw new Error(`Repo not found or private (Status: ${response.status}).`);
                    const data = await response.json();
                    
                    messageCenter.classList.add('hidden');
                    renderBreadcrumbs(user, repo, path);
                    
                    data.sort((a, b) => {
                        if (a.type === 'dir' && b.type !== 'dir') return -1;
                        if (a.type !== 'dir' && b.type === 'dir') return 1;
                        return a.name.localeCompare(b.name);
                    });

                    if (data.length === 0) {
                         messageCenter.innerHTML = `<p>This directory is empty.</p>`;
                         messageCenter.classList.remove('hidden');
                    }

                    data.forEach(item => {
                        const listItem = document.createElement('md-list-item');
                        listItem.headline = item.name;
                        listItem.type = 'link'; 
                        const icon = document.createElement('md-icon');
                        icon.slot = 'start';
                        icon.textContent = item.type === 'dir' ? 'folder' : 'draft';
                        listItem.appendChild(icon);

                        if (item.type === 'dir') {
                            listItem.href = 'javascript:void(0)';
                            listItem.addEventListener('click', (e) => {
                                e.preventDefault();
                                loadRepo(user, repo, item.path);
                            });
                        } else {
                            const extension = item.name.split('.').pop().toLowerCase();
                            const isImageViewable = VIEWABLE_EXTENSIONS.image.includes(extension);
                            const isVideoViewable = VIEWABLE_EXTENSIONS.video.includes(extension);

                            if (isImageViewable || isVideoViewable) {
                                const mediaType = isImageViewable ? 'image' : 'video';
                                const viewerUrl = new URL(window.location);
                                viewerUrl.searchParams.set('view', item.download_url);
                                viewerUrl.searchParams.set('type', mediaType);
                                listItem.href = viewerUrl.href;
                                listItem.target = '_blank';
                            } else {
                                listItem.href = item.download_url;
                                listItem.target = '_blank';
                            }
                        }
                        fileList.appendChild(listItem);
                    });
                } catch (error) {
                    messageCenter.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                }
            };

            const renderBreadcrumbs = (user, repo, path) => {
                breadcrumbs.innerHTML = '';
                const homeLink = document.createElement('a');
                homeLink.className = 'breadcrumb-link';
                homeLink.textContent = repo;
                homeLink.href = 'javascript:void(0)';
                homeLink.onclick = (e) => { e.preventDefault(); loadRepo(user, repo, ''); };
                breadcrumbs.appendChild(homeLink);

                const parts = path.split('/').filter(Boolean);
                let currentPath = '';
                parts.forEach(part => {
                    currentPath += `${part}/`;
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator material-symbols-outlined';
                    separator.textContent = 'chevron_right';
                    breadcrumbs.appendChild(separator);
                    const partLink = document.createElement('a');
                    partLink.className = 'breadcrumb-link';
                    partLink.textContent = part;
                    partLink.href = 'javascript:void(0)';
                    const pathToLoad = currentPath.slice(0, -1); 
                    partLink.onclick = (e) => { e.preventDefault(); loadRepo(user, repo, pathToLoad); };
                    breadcrumbs.appendChild(partLink);
                });
            };

            const showEditView = () => {
                displayView.classList.add('hidden');
                editView.classList.remove('hidden');
            };

            const showDisplayView = () => {
                editView.classList.add('hidden');
                displayView.classList.remove('hidden');
            };

            changeRepoBtn.addEventListener('click', showEditView);

            saveRepoBtn.addEventListener('click', () => {
                const user = userInput.value.trim();
                const repo = repoInput.value.trim();
                if (user && repo) {
                    repoTitle.textContent = `${user} / ${repo}`;
                    loadRepo(user, repo);
                    showDisplayView();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                const { user, repo } = detectRepoInfo();
                if (user && repo) {
                    repoTitle.textContent = `${user} / ${repo}`;
                    userInput.value = user;
                    repoInput.value = repo;
                    loadRepo(user, repo);
                } else {
                    repoTitle.textContent = 'No Repo Detected';
                    messageCenter.innerHTML = `<p>Could not auto-detect repository. Please enter one manually.</p>`;
                    showEditView();
                }
            });
        }
        
        // Start the correct mode for the page.
        initializePage();
    </script>
</body>
</html>
